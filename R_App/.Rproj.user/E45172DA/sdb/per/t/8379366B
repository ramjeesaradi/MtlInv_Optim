{
    "collab_server" : "",
    "contents" : "require(dummies)\n\nprepSol <- function(sol,rmpart,params,requirements,StkInp){\n  solution <- data.frame(Name = params$pairnms, qnty = sol$solution )\n  if(length(params$pairnms)==1){\n  solution <- cbind(solution, Splitclmn(solution$Name,\"_\"),as.vector((params$wstprct)), as.vector((params$Cost1)), rep(params$message,nrow(solution)))\n  }else{solution <- cbind(solution, Splitclmn(solution$Name,\"_\"),as.vector(t(params$wstprct)), as.vector(t(params$Cost1)),rep(params$message,nrow(solution)))}\n  solution <- solution[solution$qnty !=0,]\n  names(solution) <- c(names(solution)[1:2],\"SFG\", \"Sheet\",\"Coil\",\"Length\", \"Breadth\",\"Batch\", \"Stock\", \"wastage\", \"Cost\", \"Remarks\")\n  solution.out <- cast(solution, SFG+ Sheet+Coil+Length+ Breadth+ Batch + wastage + Cost + Remarks ~ Stock, value = \"qnty\",fun.aggregate = sum,fill = 0)\n  \n  solution.out <- renameCol(solution.out,\"inStock\", \"fromStock\")\n  solution.out <- renameCol(solution.out,\"noStock\", \"Purchase\")\n  # solution.out <- solution.out[,c(\"SFG\",\"Coil\",\"Sheet\",\"Length\", \"RM.Breadth\",\"wastage\", \"Batch\", \"fromStock\", \"Purchase\",\"RM.Lead.Time\")]\n  \n  return(solution.out)\n}\nwrite2Disk <- function(tabl,params,run){\n  tabl <- data.frame(lapply(tabl, as.character), stringsAsFactors=FALSE)\n  if(! (\"Purchase\" %in% names(tabl))){\n    tabl$Purchase <- 0\n  }\n  if(!(\"fromStock\" %in% names(tabl))){tabl$fromStock <- 0}\n  tabl <- tabl[,c(\"Order.No\",\"Item\",\"SFG\",\"Coil\",\"Sheet\",\"Length\",\"Breadth\",\"Batch\",\"wastage\",\"fromStock\",\"Purchase\", \"Cost\",\"Remarks\")]\n  output0 <- merge(requirements[(requirements$RM.Length==0) & (requirements$RM.Breadth==0),!(names(requirements) %in% c(\"RM.Length\",\"RM.Breadth\"))], tabl\n                  ,by.x = c(\"Order.No\",\"Item\",\"SFG.Material\",\"Raw.Material\")\n                  ,by.y = c(\"Order.No\",\"Item\",\"SFG\",\"Sheet\")\n                  ,all.x = T)\n  output0 <- renameCol(output0,\"Length\",\"RM.Length\" )\n  output0 <- renameCol(output0,\"Breadth\",\"RM.Breadth\" )\n  output1 <- merge(requirements[!is.na(requirements$RM.Breadth),], tabl\n                   ,by.x = c(\"Order.No\",\"Item\",\"SFG.Material\",\"Raw.Material\",\"RM.Length\",\"RM.Breadth\")\n                   ,by.y = c(\"Order.No\",\"Item\",\"SFG\",\"Sheet\",\"Length\",\"Breadth\")\n                   ,all.x = T)\n  output <- rbind.fill(output0,output1)\n  StkInp <- renameCol(StkInp,oldname = \"Plant\", \"Stock.Plant\")\n  output <- merge( output, unique(StkInp[,c(\"Batch\",\"Storage.Location\")])\n                   #todo add ,\"Location\"\n                  ,by = c(\"Batch\")\n                  # ,by.y = c(\"Batch\")\n                  ,all.x = T)\n  output <- cbind(output,Splitclmn(output$Batch,\"-\",outcols = 5))\n  output <- rmclmn(output,\"Batch\")\n  output <- renameCol(output,\"1\",\"Batch\")\n  output <- renameCol(output,\"2\",\"Plant.Considered\")\n  output <- renameCol(output,\"3\",\"Storage.Location\")\n  output <- renameCol(output,\"4\",\"PO.Number\")\n  output <- renameCol(output,\"5\",\"PR.Number\")\n  output$fromPR <- sapply(1:nrow(output)\n                          , function (x) ifelse(output$PR.Number[x] != \" \",output$fromStock[x],0))\n  output$fromPO <- sapply(1:nrow(output)\n                          , function (x) ifelse(output$PO.Number[x] != \" \",output$fromStock[x],0))\n  \n  output <- output[,c(\"Order.No\",\"Item\",\"Plant\",\"Order.Req\",\"Forecast.Date\",\"Req.Delivery.Date\",\"Mfg.Lead.time\",\"KIT.Material\",\"FG.Material\",\"FG.Net.Req\",\"SFG.Material\",\"SFG.Net.Req\",\"FG.SFG.Length\",\"FG.SFG.Breadth\",\"Coil\",\"Raw.Material\",\"RM.Length\",\"RM.Breadth\",\"RM.Qty.Set\",\"Priority\",\"Plant.Considered\",\"Batch\",\"Storage.Location\",\"fromStock\",\"Purchase\",\"wastage\",\"Remarks\", \"PO.Number\", \"PR.Number\", \"fromPO\",\"fromPR\")]\n  output <- output[order(output$Order.No,output$Forecast.Date),]\n  output[(output$FG.Material==output$SFG.Material),c(\"SFG.Material\",\"SFG.Net.Req\")] <- NA\n  output <- unique(output)\n  ## to add when time sstamp is needed ,\"_\", format(Sys.time(), format = \"%Y%m%d_%H%M%S\")\n  filename <- paste(c(\"R_Output/R_Sol_\",run,\".csv\"),collapse = \"\")\n  filename1 <- paste(c(\"R_Output/R_Sol_\",unique(requirements$Plant)[1],\".csv\"),collapse = \"\")\n  write.table(output,filename,row.names = F,quote = F,na = \"\",sep = \"|\")\n  write.table(output,filename1,row.names = F,quote = F,na = \"\",sep = \"|\")\n  #TO DO paste(c(\"Solution_\",params$wastage.threshold,\".csv\"),collapse = \"\")\n}\n\nupdateStk <- function(sol,StkInp){\n  if(nrow(StkInp) >= 1 & \"fromStock\" %in% names(sol)){\n    sol <- sol[!is.na(sol$Batch)]\n   usedStk <- aggregate(fromStock ~ Batch,sol, sum,na.action = na.omit)\n  # View(usedStk)\n  for(i in usedStk$Batch){\n    # print(i)\n    # print(usedStk$fromStock[usedStk$Batch == i])\n    StkInp$Warehouse.Stock[StkInp$Batch == i]<- round(StkInp$Warehouse.Stock[StkInp$Batch == i] - usedStk$fromStock[usedStk$Batch == i],6)\n    # StkInp$Warehouse.Stock[StkInp$Batch == i]<- StkInp$Warehouse.Stock[StkInp$Batch == i] - usedStk$fromStock[usedStk$Batch == i]\n    # StkInp$Warehouse.Stock[StkInp$Warehouse.Stock < 1e-4] <- 0\n  }\n  return(StkInp)} else(return(StkInp))\n}\n\nconsolStk <- function(StkInp){\n  StkInpPR <- rmclmn(StkInp,c(\"PO.Number\", \"Open.PO.s\"))\n  StkInpPO <- rmclmn(StkInp,c(\"PR.Number\", \"Open.PR.s\"))\n  StkInp <- unique(rbind.fill(StkInpPO,StkInpPR))\n  StkInp <- StkInp[!((is.na(StkInp$Batch) | StkInp$Batch == \"\" ) & is.na(StkInp$PO.Number) & is.na(StkInp$PR.Number)),]\n  \n  StkInp$Warehouse.Stock[is.na(StkInp$Warehouse.Stock)] <- 0\n  StkInp$Open.PR.s[is.na(StkInp$Open.PR.s)] <- 0\n  StkInp$Open.PO.s[is.na(StkInp$Open.PO.s)] <- 0\n  # StkInp$Subcon.Stock[is.na(StkInp$Subcon.Stock)] <- 0\n  StkInp$Warehouse.Stock <- StkInp$Warehouse.Stock + StkInp$Open.PO.s + StkInp$Open.PR.s\n  \n  # StkInp$Warehouse.Stock <- StkInp$Warehouse.Stock + StkInp$Subcon.Stock\n  # StkInp$Subcon.Stock <- 0\n  \n  StkInp$PO.Number[is.na(StkInp$PO.Number)] <- \" \"\n  StkInp$PR.Number[is.na(StkInp$PR.Number)] <- \" \"\n  \n  StkInp$Batch <- do.call(paste,c(StkInp[,c(\"Batch\",\"Plant\",\"Storage.Location\", \"PO.Number\", \"PR.Number\")],sep = \"-\"))\n  return(StkInp)\n}\n\nrenameCol <- function(df,oldname, newname){\n  names(df)[names(df) %in% oldname] <- newname\n  # names(df) <- newnames\n  return(df)\n}\n\ngoodsPerRawMet <- function(df){\n  rmL <- df$RM.Length\n  rmW <- df$RM.Breadth\n  sfL <- df$SFG.Length\n  sfW <- df$SFG.Breadth\n  rmT <- df$RM.Width\n  rmD <- df$RM.Density\n  rmWst <- df$conWst\n  \n  rmWt <- rmL*rmW*rmT*rmD*(1+(rmWst/100))\n  \n  nll <- floor(rmL/sfL)*floor(rmW/sfW)\n  nlw <- floor(rmW/sfL)*floor(rmL/sfW)\n  \n  Qnty <- df$Qnty\n  priority <- df$Priority\n  Qnty <- sapply(c(1:length(Qnty))\n               , function (x){\n                 ifelse(priority[x]==0,\n                    (max(c(nll[x],nlw[x]))*1000000/rmWt[x])\n                 ,Qnty[x])})\n  \n  return(Qnty)\n}\n\nsfgwt <-  function(df){\n  sfL <- df$SFG.Length\n  sfW <- df$SFG.Breadth\n  rmT <- df$RM.Width\n  rmD <- df$RM.Density\n  \n  wt <- sfL*sfW*rmT*rmD\n  return(wt)\n}\nwastage <- function(df){\n  rmL <- df$RM.Length\n  rmW <- df$RM.Breadth\n  sfL <- df$SFG.Length\n  sfW <- df$SFG.Breadth\n  #Sheet.Length to Sheet.Length\n  nll <- floor(rmL/sfL)\n  nww <- floor(rmW/sfW)\n  #Sheet.Length to Coil.Width\n  nlw <- floor(rmL/sfW)\n  nwl <- floor(rmW/sfL)\n  \n  ll <- nll*sfL*nww*sfW\n  lw <- nlw*sfL*nwl*sfW\n  usedArea <-  sapply(1:nrow(df), function (x) max(ll[x],lw[x]))\n  totalArea <- rmL*rmW\n  wastage <- 1-(usedArea/totalArea)\n  return(wastage*100)\n}\n# wastage(rmpart)\n\ntoBool <- function(df,skips = NULL){\n  if(is.null(skips)){\n    dfout <- data.frame(id = 1:nrow(df))\n  }else {\n    dfout <- data.frame(df[,skips])\n    names(dfout) <- skips}\n  \n  for(name in names(df)[!(names(df) %in% skips)]){\n    if (is.factor(df[, name])){\n      dfout <- data.frame(dfout,dummy(name,df))\n    }else {\n      dfout[,name] <- df[, name]\n    }\n  }\n  return(dfout)\n}\n\nrmclmn<- function(df, clmns){\n  return(df[,!(names(df) %in% clmns)])\n}\n\nSplitclmn <- function(col,Split,outcols = 2){\n  out.df <- t(as.data.frame(sapply(col, function (x) ifelse(x==\"\",list(rep(\"\",outcols)),strsplit(as.character(x), Split)))))\n  row.names(out.df) <- NULL\n  return(out.df)\n}\n\nreqOff <- function(sol,params){\n  req <- t(params$sfg0[,ncol(sfg0)])\n  produce <- sol %*% t(params$sfg0[,-ncol(sfg0)])\n  satis <- list(prd = produce,req = req, dif = req-produce)\n  return(satis)\n}\n\ngetconWst <- function(df){\n  cW <- df$Coil.Width\n  sL <- df$Sheet.Length\n  sW <- df$Sheet.Breadth\n  dW <- sapply(c(1:length(cW)), function (x) ifelse(cW[x]/sW[x] >= 1,(cW[x] - floor(cW[x]/sW[x])*sW[x]),cW[x]))\n  dL <- sapply(c(1:length(cW)), function (x) ifelse(cW[x]/sL[x] >= 1,(cW[x] - floor(cW[x]/sL[x])*sL[x]),cW[x]))\n  wst <- sapply(c(1:length(cW)), function (x) 100*min(dL[x], dW[x])/cW[x])\n  return(wst)\n}\n\ndiffPlant <- function(plant,batch){\n  stkPlant <- as.numeric(Splitclmn(batch,\"-\",5)[,2])\n  stkPlant[is.na(stkPlant)]<-0\n  bool <- (stkPlant !=plant & stkPlant !=0)\n  # & stkPlant !=\"\"\n  bool[bool == T] <- 1\n  return(bool)\n}\npopulateCoilwidth <- function(requirements,conv){\n  reqCoil <- merge(requirements,unique(conv[,c(\"From.Material.Number\",\"Coil.Width\")]),by.x = \"Raw.Material\",by.y = \"From.Material.Number\",all.x = T)\n  reqCoil[!is.na(reqCoil$Coil.Width), \"RM.Breadth\"] <- reqCoil[!is.na(reqCoil$Coil.Width), \"Coil.Width\"]\n  return(reqCoil[,!(names(reqCoil) %in% \"Coil.Width\")])\n}\n\ngetFeasibleOpts <- function(rmpart,wastage.threshold){\n  rmpart2 <- rmpart[rmpart$totalLead <= rmpart$duein, ]\n  if(!(nrow(rmpart2) >=1)){\n    rmpart2 <- rmpart\n    params$message <<- \"Lead over due Date\"\n  }\n  rmpart1 <- rmpart2[rmpart2$wastage <= wastage.threshold | rmpart2$Priority > 0]\n  if(!(nrow(rmpart1) >=1)){\n    rmpart1 <- rmpart2\n    params$message <<- \"No Feasible Wastage\"\n  }\n  return(rmpart1)\n}",
    "created" : 1464680709105.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2811048755",
    "id" : "8379366B",
    "lastKnownWriteTime" : 1464771905,
    "last_content_update" : 1464771905863,
    "path" : "~/workspace/Veero Optim/R_App/Fns.R",
    "project_path" : "Fns.R",
    "properties" : {
        "docOutlineSize" : "108",
        "docOutlineVisible" : "0"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}