{
    "collab_server" : "",
    "contents" : "\ngetrmpart <- function(requirements,StkInp,conv) {\n  requirements$sfg <- requirements$SFG.Material\n  requirements$sfg <- sapply(requirements$sfg, function (x) gsub(\"\\t\", \"\", x))\n  requirements <- requirements[!is.na(requirements$Plant),]\n  foreCastdt <-  as.Date(as.factor(requirements$Req.Delivery.Date), \"%d.%m.%Y\")\n  plant <- unique(requirements$Plant)[1]\n  \n  requirements$duein <- difftime(as.Date(as.factor(requirements$Req.Delivery.Date),\"%d.%m.%Y\"),Sys.Date())\n  \n  requirementsCoil <- merge(requirements[!(requirements$RM.Length==0) & !(requirements$RM.Breadth==0),]\n                            ,requirements[(requirements$RM.Length==0) & !(requirements$RM.Breadth==0),c(\"Raw.Material\",\"SFG.Material\",\"Priority\")]\n                            ,by = \"SFG.Material\"\n                            )\n  requirementsCoil <- renameCol(requirementsCoil,\"Raw.Material.x\",\"Raw.Material\")\n  requirementsCoil <- renameCol(requirementsCoil,\"Raw.Material.y\",\"con\")\n  requirementsCoil <- renameCol(requirementsCoil,\"Priority.y\",\"Priority\")\n  requirementsCoil <- rmclmn(requirementsCoil,\"Priority.x\")\n  \n  requirements <- rbind.fill(requirements,requirementsCoil)\n  if(nrow(requirements[is.na(requirements$con), ])>=1){\n  requirements[is.na(requirements$con), \"con\"] <- \"\"}\n  \n  # requirements$nsfg <- goodsPerRawMet(rmL = RM.Length,rmW = RM.Breadth, sfL = FG.SFG.Length,sfW = Breadth)\n  \n  sfgreq <- aggregate(SFG.Net.Req~sfg+duein,requirements, max)\n  #######\n  StkInp <- StkInp[StkInp$Warehouse.Stock > 0, ]\n  StkInp$Type <- sapply(StkInp$Type, function (x) ifelse(x==\"END BAND\", 1,0))\n  ######################################################input 2############################\n  \n  \n  StkInp$RM.Length[is.na(StkInp$RM.Length)] <- 0\n  StkInp$RM.Breadth[is.na(StkInp$RM.Breadth)] <- 0\n  StkInp$Warehouse.Stock[is.na(StkInp$Warehouse.Stock)] <- 0\n  ############################## Assign Priority ##############\n  \n  requirements$Priority[requirements$Priority == 0]<- 1\n  \n  requirements$Priority[requirements$RM.Breadth == 0]<- 0\n  \n  ###################################################### Conv ############################\n  #######################Table of Purchasable and convertable RawMaterial###########################################\n  rm1 <- requirements[,c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\",\"RM.Thickness\",\"RM.Density\",\"Moving.Average.Price\",\"RM.Lead.Time\")]\n  # rm2 <- StkInp[StkInp$Type ==1 ,c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\",\"RM.Thickness\",\"RM.Density\")]\n  rm2 <- StkInp[,c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\",\"RM.Thickness\",\"RM.Density\",\"Moving.Average.Price\",\"RM.Lead.Time\")]\n  rm3 <- conv[,c(\"To.Material.Number\",\"Sheet.Breadth\",\"Sheet.Length\",\"Sheet.Thickness\",\"Density\",\"From.Material.Number\",\"Conversion.Cost\",\"Wastage\" )]\n  names(rm1) <- c(\"RM\",\"RM.Breadth\",\"RM.Length\",\"RM.Width\",\"RM.Density\", \"SheetCost\",\"RM.Lead.Time\")\n  \n  names(rm2) <- c(\"RM\",\"RM.Breadth\",\"RM.Length\",\"RM.Width\",\"RM.Density\", \"SheetCost\",\"RM.Lead.Time\")\n  ####Remove coil from the sheet stocks\n  # rmS <- rm1[(rm1$RM.Length != 0 | rm1$RM.Breadth != 0),]\n  rmS <- rm1[(rm1$RM.Breadth != 0),]\n  rmS2 <- rm2[(rm2$RM.Length != 0 | rm2$RM.Breadth != 0),]\n  rmC0 <- merge(rm3,unique(rbind(rm1[(rm1$RM.Length == 0),c(\"RM\",\"SheetCost\",\"RM.Lead.Time\")],\n                                rm2[(rm2$RM.Length == 0),c(\"RM\",\"SheetCost\",\"RM.Lead.Time\")]))\n               ,by.x = \"From.Material.Number\", by.y = \"RM\"\n               )\n  rmC1 <- merge(rm3,unique(rm1[(rm1$RM.Length == 0),c(\"RM\",\"SheetCost\",\"RM.Lead.Time\")])\n                ,by.x = \"From.Material.Number\", by.y = \"RM\"\n  )\n  names(rmC0) <- c( \"con\",\"RM\", \"RM.Breadth\",\"RM.Length\",\"RM.Width\",\"RM.Density\",\"conCost\",\"conWst\",\"CoilCost\",\"RM.Lead.Time\")\n  names(rmC1) <- c( \"con\",\"RM\", \"RM.Breadth\",\"RM.Length\",\"RM.Width\",\"RM.Density\",\"conCost\",\"conWst\",\"CoilCost\",\"RM.Lead.Time\")\n \n   if(nrow(rmS) >= 1){\n    rmS[,c(\"conCost\",\"conWst\",\"CoilCost\")] <- 0\n    rmS$con <- \"\"}\n  if(nrow(rmS2) >= 1){\n    rmS2[,c(\"conCost\",\"conWst\",\"CoilCost\")] <- 0\n    rmS2$con <- \"\"}\n  if(nrow(rmC0) >= 1){rmC0[,\"SheetCost\"] <- 0}\n  if(nrow(rmC1) >= 1){rmC1[,\"SheetCost\"] <- 0}\n  \n  #with coil only specified in req & stock\n  rm0 <- rbind.fill(rmS,rmC0,rmS2)\n  rm0 <- unique(rm0)\n  rm0 <- rm0[rm0$RM.Length > 0,]\n  #with coil only specified in req\n  rm1 <- rbind.fill(rmS,rmC1,rmS2)\n  rm1 <- unique(rm1)\n  rm1 <- rm1[rm1$RM.Length > 0,]\n  #Remove raw meterials with no Length or Breadth\n  # rm <- rm[which(!(is.na(rm$RM.Breadth) | is.na(rm$RM.Length))),]\n  \n  ####################################SFG(parts) with their compatible RM########################################\n  # rmpart <- merge(rm,requirements,\n  #                 by.x = c(\"RM\",\"RM.Breadth\",\"Length\"), \n  #                 by.y =c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\"),\n  #                 all.x = T)\n  \n  rmpart0 <- unique(merge(rm0,\n                  unique(requirements[requirements$Priority ==0,c(\"Raw.Material\",\"SFG.Material\", \"FG.SFG.Length\",\"FG.SFG.Breadth\",\"Mfg.Lead.time\",\"RM.Qty.Set\",\"Priority\")]),\n                  by.x = c(\"RM\"), \n                  by.y =c(\"Raw.Material\")\n                  ,all.y = T))\n  names(rmpart0) <- c(names(rm0),\"SFG\",\"SFG.Length\",\"SFG.Breadth\",\"Manf.Lead\",\"Qnty\",\"Priority\")\n  if(nrow(rmpart0) >= 1){\n  rmpart0$Qnty <- sapply(c(1:nrow(rmpart0)), function (x) ifelse(is.na(rmpart0$RM.Length[x]),rmpart0$Qnty[x],NA))\n  rmpart0$con <- sapply(c(1:nrow(rmpart0)), function (x) ifelse(is.na(rmpart0$RM.Length[x]),\"\",rmpart0$con[x]))\n  rmpart0$RM.Length <- sapply(c(1:nrow(rmpart0)), function (x) ifelse(is.na(rmpart0$RM.Length[x]),rmpart0$SFG.Length[x],rmpart0$RM.Length[x]))\n  rmpart0$RM.Breadth <- sapply(c(1:nrow(rmpart0)), function (x) ifelse(is.na(rmpart0$RM.Breadth[x]),rmpart0$SFG.Breadth[x],rmpart0$RM.Breadth[x]))\n  }\n  rmpart1 <- unique(merge(rm1,\n                          unique(requirements[requirements$Priority >=1,c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\",\"SFG.Material\", \"FG.SFG.Length\",\"FG.SFG.Breadth\",\"Mfg.Lead.time\",\"Priority\",\"RM.Qty.Set\",\"con\")]),\n                          by.x = c(\"RM\",\"RM.Breadth\",\"RM.Length\",\"con\"),\n                          by.y =c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\",\"con\")\n                          ))\n  # names(rmpart1) <- c(names(rm1),\"SFG\",\"SFG.Length\",\"SFG.Breadth\",\"Manf.Lead\",\"Priority\", \"Qnty\")\n  rmpart1 <- renameCol(rmpart1,\"SFG.Material\",\"SFG\")\n  rmpart1 <- renameCol(rmpart1,\"FG.SFG.Length\",\"SFG.Length\")\n  rmpart1 <- renameCol(rmpart1,\"FG.SFG.Breadth\",\"SFG.Breadth\")\n  rmpart1 <- renameCol(rmpart1,\"Mfg.Lead.time\",\"Manf.Lead\")\n  rmpart1 <- renameCol(rmpart1,\"Priority\",\"Priority\")\n  rmpart1 <- renameCol(rmpart1,\"RM.Qty.Set\",\"Qnty\")\n  \n  \n  rmpart <- rbind.fill(rmpart0,rmpart1)\n  rmpart$Qnty <- 1/rmpart$Qnty\n  # nms <- names(rmpart) <- c(names(rm),\"SFG\",\"SFG.Length\",\"SFG.Breadth\",\"Manf.Lead\")\n  \n  #################################################################################################################\n  #Populating sheet And Coil Stocks and Batch\n  rmpartSheet <- merge(rmpart[rmpart$con==\"\",],\n                  StkInp[,!(names(StkInp) %in% c(\"RM.Lead.Time\",\"RM.Density\"))],\n                  by.x = c(\"RM\",\"RM.Breadth\",\"RM.Length\"),\n                  by.y = c(\"Raw.Material\",\"RM.Breadth\",\"RM.Length\")\n                  ,all.x = T)[,c(names(rmpart),\"Warehouse.Stock\",\"Batch\",\"Type\")]\n  rmpartSheet <- renameCol(rmpartSheet,\"Warehouse.Stock\", \"SheetStock\")\n  rmpartSheet$SheetCost[rmpartSheet$Type == 1 ] <- 0\n  rmpartSheet$RM.Lead.Time[rmpartSheet$Type == 1 ] <- 0\n  # rmpartSheet <- renameCol(rmpartSheet, \"Moving.Average.Price\", \"SheetCost\")\n  rmpartCoil <- merge(rmpart[rmpart$con!=\"\",],\n                  StkInp[StkInp$RM.Length==0,!(names(StkInp) %in% c(\"RM.Lead.Time\",\"RM.Density\",\"RM.Length\",\"RM.Breadth\"))],\n                  by.x = c(\"con\")\n                  ,by.y = c(\"Raw.Material\")\n                  ,all.x = T)[,c(names(rmpart),\"Warehouse.Stock\",\"Batch\")]\n  rmpartCoil <- renameCol(rmpartCoil,\"Warehouse.Stock\", \"CoilStock\")\n  # rmpartCoil <- renameCol(rmpartCoil, \"Moving.Average.Price\", \"CoilCost\")\n  rmpart <- rbind.fill(rmpartSheet,rmpartCoil)\n  rmpart$CoilStock[is.na(rmpart$CoilStock)] <- 0\n  rmpart$SheetStock[is.na(rmpart$SheetStock)] <- 0\n  rmpart$Type[is.na(rmpart$Type)] <- 0\n  \n  rmpart <- rmpart[!is.na(rmpart$RM),]\n  rmpart$WstCost <- rmpart$CoilCost + rmpart$SheetCost +rmpart$conCost\n  \n  ########################### Separate entries for each RM with Stock and with out stock ###############################\n\n  if(nrow(rmpart) >= 1){rmpart[,\"inStock\"] <- NA}\n  rmpart$Type[(rmpart$Type==\"NULL\")] <- 0\n  rmpartShinStock <- rmpart[rmpart$SheetStock > 0 & rmpart$Type != 1,]\n  rmpartCoinStock <- rmpart[rmpart$CoilStock > 0,]\n  #Eliminating noStock entry for EndBands\n  rmpart$inStock[rmpart$Type != 1] <- \"noStock\"\n  rmpart$inStock[rmpart$Type == 1] <- \"inStock\"\n  rmpart$Batch[rmpart$Type != 1] <- \"\"\n  rmpart$WstCost[rmpart$Type == 1] <- 0\n  \n  #Change cost of \"inStock\" rm to 0 except coils to sheet convesion Cost\n  if(nrow(rmpartShinStock) != 0){\n    rmpartShinStock$inStock <- \"inStock\"\n    rmpartShinStock$SheetCost <- 0\n    rmpartShinStock$CoilCost <- 0\n    rmpartShinStock$CoilStock <- 0\n    rmpartShinStock$RM.Lead.Time <- 0\n    }\n  \n  if(nrow(rmpartCoinStock) != 0){\n    rmpartCoinStock$inStock <- \"inStock\"\n    rmpartCoinStock$CoilCost <- 0\n    rmpartCoinStock$SheetCost <- 0\n    rmpartCoinStock$RM.Lead.Time <- 0\n    }\n  #\n  if(nrow(rmpart) >= 1){rmpart$CoilStock <- 0}\n  rmpart$SheetStock[rmpart$Type != 1] <- 0\n  rmpart <- rbind.fill(rmpart,rmpartShinStock,rmpartCoinStock)\n  rmpart$inStock[is.na(rmpart$inStock)] <- \"noStock\"\n  \n  \n  ###########################Generate Costs for each material ##############################################\n\n  rmpart[rmpart$inStock == \"inStock\",\"SheetCost\"] <- 0\n  rmpart[rmpart$inStock == \"inStock\",\"CoilCost\"] <- 0\n\n  ##Get Raw material Required quantity and Total Order Requirement\n  rmpart <- merge(rmpart,\n                  sfgreq,\n                  by.x = c(\"SFG\"),\n                  by.y = c( \"sfg\"),\n                  all.x = T)[,c(names(rmpart),\"SFG.Net.Req\",\"duein\")]\n  rmpart <- renameCol(rmpart,\"SFG.Net.Req\", \"Req\")\n  \n  ##########################################################################################################\n  rmpart <- rmpart[!is.na(rmpart$SFG),]\n  rmpart$Batch[is.na(rmpart$Batch)] <- \"\"\n  rmpart$Priority[is.na(rmpart$Priority)] <- 0\n  #Parts produced per KG Raw material)\n  rmpart[,\"Qnty\"] <- goodsPerRawMet(rmpart)\n  #Assign wastage for RM,SFG pairs\n  rmpart$wastage <- wastage(rmpart) + rmpart$conWst\n  # rmpart$tsfgwt <- sfgwt(rmpart)*rmpart$Req\n  rmpart$diffPlant <- diffPlant(plant,rmpart$Batch)\n  ###########################Generate Total Costs for each material #########################################\n  rmpart$totalCost <- rmpart$conCost + rmpart$SheetCost + rmpart$CoilCost + rmpart$WstCost*(rmpart$wastage)/100\n  # rmpart$totalCost <- sapply(c(1:nrow(rmpart)),\n  #                       function (x) ifelse(rmpart[x,\"Priority\"]>=1,rmpart[x,\"Priority\"],rmpart[x,\"totalCost\"]))\n  # \n  rmpart$totalCost <- rmpart$totalCost*(1+0.01*rmpart$diffPlant)\n  rmpart$cost1 <- rmpart$conCost + rmpart$SheetCost + rmpart$CoilCost\n  ###########################Generate Total Lead for each SFG #########################################\n  rmpart$totalLead <- rmpart$Manf.Lead + rmpart$RM.Lead.Time\n  ######################## Apply Filters to Clean master table#########################\n  #Create duplicate coulumns for casting/pivoting to matrix\n  rmpart[is.na(as.matrix(rmpart))] <- 0\n  rmpart$SFG_ <- rmpart$SFG\n  rmpart$RM_ <- rmpart$RM\n  rmpart$RM.Length_ <- rmpart$RM.Length\n  rmpart$RM.Breadth_ <- rmpart$RM.Breadth\n  rmpart$con_ <- rmpart$con\n  rmpart$Batch_ <- rmpart$Batch\n  rmpart <- rmpart[rmpart$Qnty != 0,]\n  rmpart <- rmpart[!is.na(rmpart$RM),]\n  return(rmpart)\n}\n\n##########################################################################################################",
    "created" : 1464609358714.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3639815533",
    "id" : "3F68EE64",
    "lastKnownWriteTime" : 1464610628,
    "last_content_update" : 1464610628661,
    "path" : "~/workspace/Veero Optim/R_App/optimDataPrep.R",
    "project_path" : "optimDataPrep.R",
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}